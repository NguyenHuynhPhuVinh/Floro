# Story 1.1: Thi·∫øt l·∫≠p D·ª± √°n v√† H·∫° t·∫ßng

## Status

Blocked - Architecture Migration Required

## Story

**As a** developer,
**I want** to set up a new Next.js project with Supabase integration and continuous deployment via Vercel,
**so that** we have a solid and automated foundation.

## Acceptance Criteria

1. Repository m√£ ngu·ªìn m·ªü m·ªõi ƒë∆∞·ª£c t·∫°o tr√™n GitHub.
2. D·ª± √°n Next.js (TypeScript) ƒë∆∞·ª£c kh·ªüi t·∫°o trong monorepo.
3. D·ª± √°n Supabase m·ªõi ƒë∆∞·ª£c t·∫°o v√† k·∫øt n·ªëi.
4. D·ª± √°n ƒë∆∞·ª£c k·∫øt n·ªëi v·ªõi Vercel v√† t·ª± ƒë·ªông tri·ªÉn khai.
5. Trang ch·ªß hi·ªÉn th·ªã m·ªôt trang ch√†o m·ª´ng.

## Tasks / Subtasks

- [x] Task 1: Thi·∫øt l·∫≠p monorepo structure (AC: 2)
  - [x] T·∫°o root package.json v·ªõi pnpm workspace configuration
  - [x] T·∫°o apps/web directory cho Next.js application
  - [x] T·∫°o packages directory cho shared packages
  - [x] Thi·∫øt l·∫≠p pnpm-workspace.yaml
- [x] Task 2: Kh·ªüi t·∫°o Next.js project v·ªõi TypeScript (AC: 2)
  - [x] Kh·ªüi t·∫°o Next.js 14+ project trong apps/web
  - [x] C·∫•u h√¨nh TypeScript v·ªõi strict mode
  - [x] Thi·∫øt l·∫≠p Tailwind CSS v4
  - [x] C·∫•u h√¨nh ESLint v√† Prettier theo coding standards
- [ ] Task 3: MIGRATION - Replace Firebase with Supabase integration (AC: 3) - CRITICAL
  - [ ] Remove all Firebase dependencies and code
  - [ ] Create new Supabase project and configure services
  - [ ] Install Supabase client SDK (@supabase/supabase-js)
  - [ ] Implement Supabase service layer (supabase.ts, node.service.ts, storage.service.ts, realtime.service.ts)
  - [ ] Set up PostgreSQL database schema with PostGIS extension
  - [ ] Configure Row Level Security (RLS) policies
  - [ ] Update environment variables for Supabase (URL, anon key, service role key)
  - [ ] Update all tests to mock Supabase instead of Firebase
- [ ] Task 4: C·∫•u h√¨nh Vercel deployment (AC: 4) - DEPENDS ON TASK 3
  - [ ] K·∫øt n·ªëi GitHub repository v·ªõi Vercel
  - [ ] C·∫•u h√¨nh automatic deployment t·ª´ main branch
  - [ ] Thi·∫øt l·∫≠p environment variables cho Supabase (NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_ANON_KEY)
  - [ ] C·∫•u h√¨nh preview deployments cho pull requests
  - [ ] Test deployment v·ªõi Supabase connection
- [x] Task 5: T·∫°o trang ch√†o m·ª´ng (AC: 5) - COMPLETED
  - [x] T·∫°o homepage component v·ªõi welcome message
  - [x] Implement basic layout structure v·ªõi Vietnamese content
  - [ ] Verify deployment ho·∫°t ƒë·ªông ch√≠nh x√°c (BLOCKED - pending Task 3 & 4)
- [x] Task 6: Unit testing setup - COMPLETED (needs Supabase test updates)
  - [x] C·∫•u h√¨nh Jest v√† React Testing Library
  - [x] T·∫°o test cho homepage component
  - [x] Thi·∫øt l·∫≠p test scripts trong package.json
  - [ ] Update tests to mock Supabase services (pending Task 3)

## Dev Notes

### Previous Story Insights

No previous story exists - this is the first story of the project.

### Tech Stack Requirements

[Source: architecture/3-tech-stack.md]

- **Language**: TypeScript (mandatory, strict mode)
- **Frontend Framework**: Next.js 14+ with App Router
- **Backend Service**: Supabase (PostgreSQL Database, Realtime, Storage, Auth)
- **Database**: Supabase Database (PostgreSQL) with PostGIS for spatial queries
- **Real-time Engine**: Supabase Realtime (WebSocket-based, low latency)
- **File Storage**: Supabase Storage (S3-compatible, CDN integrated)
- **Authentication**: Supabase Auth (multiple providers, JWT tokens, RLS)
- **UI Library**: Tailwind CSS
- **UI Components**: Shadcn/ui
- **State Management**: Zustand (for future stories)
- **Testing**: Jest & React Testing Library
- **Deployment**: Vercel with automatic CI/CD

### Project Structure Requirements

[Source: architecture/6-unified-project-structure.md]

- Monorepo structure managed by pnpm workspaces
- Main application in `apps/web/`
- Shared packages in `packages/` (including shared-types for Supabase)
- Next.js App Router structure in `apps/web/src/app/`
- Components organized in `apps/web/src/components/`
- Services layer in `apps/web/src/services/` (Supabase service layer)

### File Locations

Based on unified project structure:

- Root: `package.json`, `pnpm-workspace.yaml`
- Main app: `apps/web/package.json`, `apps/web/next.config.js`
- TypeScript config: `apps/web/tsconfig.json`
- Tailwind config: `apps/web/tailwind.config.js`
- Homepage: `apps/web/src/app/page.tsx`
- Components: `apps/web/src/components/`

### Coding Standards Requirements

[Source: architecture/11-coding-standards.md]

- TypeScript strict mode mandatory, no `any` type
- All functions must have explicit return types
- PascalCase for components, camelCase for hooks
- kebab-case for file names, PascalCase for component files
- Prettier and ESLint with pre-commit hooks via husky

### Deployment Architecture

[Source: architecture/8-deployment-architecture.md]

- Frontend deployed to Vercel on main branch pushes
- Supabase configurations managed via Supabase Dashboard/CLI
- Preview deployments for Pull Requests
- Environment variables for Supabase configuration (URL, anon key, service role key)

### Testing Standards

[Source: architecture/10-testing-strategy.md]

- Unit testing with Jest for services and utilities
- Component testing with React Testing Library
- Test files co-located with source files
- Mock Supabase services in tests
- Test coverage for critical paths

### Supabase Service Layer Requirements

[Source: architecture/5-api-specification-client-side-service-layer.md]

**Core Services to implement:**

- `supabase.ts`: Centralized Supabase client initialization with TypeScript types
- `node.service.ts`: CRUD operations and real-time subscriptions for FloroNode data in PostgreSQL
- `storage.service.ts`: File uploads and retrievals from Supabase Storage
- `realtime.service.ts`: Real-time subscriptions for live collaboration features

**Advanced Services:**

- `spatial.service.ts`: Spatial indexing and viewport-based queries using PostGIS
- `cache.service.ts`: Client-side caching strategies for nodes and assets
- `performance.service.ts`: Performance metrics tracking
- `error.service.ts`: Centralized error handling and reporting
- `security.service.ts`: Input sanitization and Row Level Security (RLS) policies

### Data Models Requirements

[Source: architecture/4-data-models.md]

- Shared TypeScript types in `packages/shared-types/src/index.ts`
- Database schema types for Supabase with FloroNode, Cursor, ErrorLog interfaces
- PostgreSQL-specific features: JSONB columns, PostGIS spatial types
- Row Level Security (RLS) policies for data protection

### Technical Constraints

- Must use latest stable versions of all technologies
- Supabase project must be configured for all required services (Database, Realtime, Storage, Auth)
- PostgreSQL database with PostGIS extension for spatial queries
- Row Level Security (RLS) policies for data protection
- Vercel deployment must be automatic and reliable
- All code must pass ESLint and Prettier checks

## Change Log

| Date       | Version | Description                                          | Author       |
| ---------- | ------- | ---------------------------------------------------- | ------------ |
| 2025-07-19 | 1.0     | Initial story creation                               | Scrum Master |
| 2025-07-19 | 1.1     | Updated for architecture change: Firebase ‚Üí Supabase | Scrum Master |
| 2025-07-19 | 1.2     | Status changed to BLOCKED, clarified migration tasks | Scrum Master |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

Claude Sonnet 4 (Augment Agent) - 2025-07-19

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

**Completed Tasks:**

1. **Monorepo Structure**: ‚úÖ COMPLETED - PNPM workspace with root package.json and workspace configuration
2. **Next.js Setup**: ‚úÖ COMPLETED - Next.js 14+ with TypeScript strict mode and Tailwind CSS v4
3. **Backend Integration**: ‚ùå BLOCKED - Firebase code exists, needs complete Supabase migration
4. **Welcome Page**: ‚úÖ COMPLETED - Responsive Vietnamese welcome page with modern design
5. **Testing Setup**: ‚ö†Ô∏è PARTIAL - Jest/RTL configured, but needs Supabase mock updates
6. **Code Quality**: ‚úÖ COMPLETED - ESLint with custom rules and Prettier configured

**Key Technical Decisions:**

- Used Tailwind CSS v4 which eliminates the need for tailwind.config.js
- Implemented comprehensive Firebase service layer with TypeScript interfaces (NEEDS SUPABASE MIGRATION)
- Created Vietnamese-localized content and metadata for Vietnamese users
- Set up proper TypeScript configuration with Jest types for testing
- Organized code structure following the unified project architecture

**üö® CRITICAL BLOCKING ISSUES:**

**Primary Blocker - Architecture Migration:**

- Firebase code still exists in codebase and needs complete removal
- Supabase integration must be implemented from scratch
- Cannot proceed with deployment until backend migration is complete

**Specific Migration Requirements:**

1. **Remove Firebase Dependencies**: Uninstall firebase SDK, remove all firebase imports
2. **Install Supabase**: Add @supabase/supabase-js and configure client
3. **Database Setup**: Create PostgreSQL schema with PostGIS extension
4. **Service Layer**: Implement all Supabase services (node, storage, realtime, spatial)
5. **Environment Config**: Set up Supabase environment variables
6. **Test Updates**: Replace Firebase mocks with Supabase mocks

**Dependency Chain Blocked:**

- Task 4 (Vercel deployment) ‚Üí BLOCKED by Task 3
- Task 5 deployment verification ‚Üí BLOCKED by Task 3 & 4
- AC #3 (Supabase integration) ‚Üí BLOCKED by incomplete migration

**Current State Summary:**

- ‚úÖ Frontend foundation complete (Next.js, UI, components)
- ‚ùå Backend integration incomplete (Firebase ‚Üí Supabase migration required)
- ‚ùå Deployment blocked (cannot deploy without working backend)
- ‚ùå Story cannot be marked "Done" until migration complete
- Tests are ready to run once TypeScript issues are resolved
- Project structure is prepared for future canvas and node-based features

### File List

**Root Files:**

- `package.json` - Root monorepo package configuration
- `pnpm-workspace.yaml` - PNPM workspace configuration

**Web App Files:**

- `apps/web/package.json` - Web app dependencies and scripts
- `apps/web/tsconfig.json` - TypeScript configuration with Jest types
- `apps/web/jest.config.js` - Jest testing configuration
- `apps/web/jest.setup.js` - Jest setup and mocks
- `apps/web/eslint.config.mjs` - ESLint configuration with custom rules
- `apps/web/.prettierrc` - Prettier code formatting configuration
- `apps/web/.prettierignore` - Prettier ignore patterns
- `apps/web/postcss.config.mjs` - PostCSS configuration for Tailwind CSS v4
- `apps/web/.env.local.example` - Environment variables template

**Source Files:**

- `apps/web/src/app/layout.tsx` - Root layout with Vietnamese metadata
- `apps/web/src/app/page.tsx` - Homepage component
- `apps/web/src/app/globals.css` - Global styles with Tailwind CSS v4
- `apps/web/src/components/common/WelcomeHero.tsx` - Welcome hero component (Vietnamese)
- `apps/web/src/lib/firebase.ts` - Firebase configuration and initialization
- `apps/web/src/services/core/firebase.service.ts` - Firestore service layer
- `apps/web/src/services/core/realtime.service.ts` - Realtime Database service layer
- `apps/web/src/services/core/storage.service.ts` - Firebase Storage service layer

**Test Files:**

- `apps/web/src/app/page.test.tsx` - Homepage component tests
- `apps/web/src/components/common/WelcomeHero.test.tsx` - WelcomeHero component tests

**Directory Structure:**

- `packages/` - Shared packages directory
- `apps/web/src/components/{ui,canvas,nodes,common}/` - Component directories
- `apps/web/src/services/{core,advanced,utils}/` - Service directories
- `apps/web/src/hooks/{canvas,nodes,realtime}/` - Custom hooks directories
- `apps/web/src/store/` - State management directory
- `apps/web/src/lib/{spatial,performance,security}/` - Utility libraries
- `apps/web/src/types/` - TypeScript type definitions

## Next Steps - Unblocking Strategy

### Immediate Actions Required (Priority Order):

1. **Create Supabase Project**

   - Sign up for Supabase account
   - Create new project with PostgreSQL database
   - Enable PostGIS extension for spatial queries
   - Configure Row Level Security (RLS) policies

2. **Remove Firebase Dependencies**

   - Uninstall firebase packages: `pnpm remove firebase`
   - Remove all Firebase imports from codebase
   - Delete Firebase configuration files

3. **Install and Configure Supabase**

   - Install Supabase client: `pnpm add @supabase/supabase-js`
   - Create Supabase client configuration
   - Set up environment variables (URL, anon key, service role key)

4. **Implement Service Layer**

   - Create core services: supabase.ts, node.service.ts, storage.service.ts, realtime.service.ts
   - Implement advanced services: spatial.service.ts, cache.service.ts, performance.service.ts
   - Update shared types for Supabase database schema

5. **Update Tests and Deploy**
   - Replace Firebase mocks with Supabase mocks
   - Configure Vercel with Supabase environment variables
   - Test deployment and verify all functionality

### Success Criteria for Unblocking:

- [ ] Supabase project created and configured
- [ ] All Firebase code removed from codebase
- [ ] Supabase service layer implemented and tested
- [ ] Vercel deployment successful with Supabase integration
- [ ] All acceptance criteria satisfied

## QA Results

_Results from QA Agent review will be added here_
