# Story 2.3: X√¢y d·ª±ng Giao di·ªán H·ªó tr·ª£ Canvas

## Status

Ready for Review

## Story

**As a** user,
**I want** to see a complete application interface with Vietnamese branding and helpful controls,
**so that** I understand the application and can configure it easily.

## Acceptance Criteria

1. Logo "Floro" hi·ªÉn th·ªã ·ªü v·ªã tr√≠ trung t√¢m ph√≠a tr√™n canvas.
2. N√∫t c√†i ƒë·∫∑t (Settings) v·ªõi icon gear ·ªü g√≥c ph·∫£i tr√™n.
3. Modal c√†i ƒë·∫∑t hi·ªÉn th·ªã khi nh·∫•p n√∫t Settings v·ªõi n·ªôi dung ti·∫øng Vi·ªát.
4. C√†i ƒë·∫∑t bao g·ªìm: hi·ªÉn th·ªã t·ªça ƒë·ªô chu·ªôt, theme, ng√¥n ng·ªØ.
5. Canvas c√≥ background pattern ho·∫∑c grid ƒë·ªÉ t·∫°o c·∫£m gi√°c kh√¥ng gian l√†m vi·ªác.
6. T·∫•t c·∫£ text trong UI s·ª≠ d·ª•ng ti·∫øng Vi·ªát.

## Tasks / Subtasks

- [x] Task 1: Implement Application Layout Structure (AC: 1, 2)

  - [x] Create AppLayout component with header and main content areas
  - [x] Create AppHeader component with centered logo and settings button
  - [x] Implement SettingsButton component with gear icon
  - [x] Integrate layout components into main application

- [x] Task 2: Build Settings Modal System (AC: 3, 4)

  - [x] Create SettingsModal component with Vietnamese content
  - [x] Implement settings categories (Display, Canvas, Collaboration)
  - [x] Create DisplaySettings component for coordinate display options
  - [x] Create CanvasSettings component for background and theme options
  - [x] Add settings state management with Zustand store

- [x] Task 3: Implement Canvas Background System (AC: 5)

  - [x] Create CanvasBackground component with multiple pattern types
  - [x] Implement GridBackground pattern renderer
  - [x] Implement DotsBackground pattern renderer
  - [x] Add background configuration options in settings

- [x] Task 4: Create Coordinate Display System (AC: 4)

  - [x] Create CoordinateDisplay component with configurable position
  - [x] Implement mouse position tracking hook
  - [x] Add coordinate format options (decimal/integer)
  - [x] Integrate with canvas viewport system

- [x] Task 5: Vietnamese Localization Implementation (AC: 6)

  - [x] Create localization hook and store
  - [x] Define Vietnamese text constants for all UI elements
  - [x] Implement language switching functionality
  - [x] Ensure all UI text uses Vietnamese by default

- [x] Task 6: Unit Testing
  - [x] Test AppLayout and AppHeader components
  - [x] Test SettingsModal with all categories
  - [x] Test CanvasBackground pattern rendering
  - [x] Test CoordinateDisplay positioning and formatting
  - [x] Test localization system and text switching
  - [x] Test settings state management and persistence

## Dev Notes

### Previous Story Insights

[Source: docs/stories/2.1.story.md#dev-agent-record]

Key learnings t·ª´ Story 2.1:

- Canvas infrastructure ƒë√£ ho√†n th√†nh v·ªõi Konva.js integration
- CanvasContainer component ƒë√£ s·∫µn s√†ng ƒë·ªÉ integrate v·ªõi layout system
- Zustand store architecture ƒë√£ ƒë∆∞·ª£c thi·∫øt l·∫≠p v√† ho·∫°t ƒë·ªông t·ªët
- Component structure ƒë√£ ƒë∆∞·ª£c organize theo unified project structure
- Testing framework ƒë√£ s·∫µn s√†ng v·ªõi Jest v√† React Testing Library

[Source: docs/stories/2.2.story.md#dev-agent-record]

Key learnings t·ª´ Story 2.2:

- UI component patterns ƒë√£ ƒë∆∞·ª£c establish v·ªõi proper TypeScript interfaces
- Error handling v√† loading states patterns ƒë√£ ƒë∆∞·ª£c implement
- Component prop drilling patterns ƒë√£ ƒë∆∞·ª£c thi·∫øt l·∫≠p
- Toast notification system ƒë√£ c√≥ s·∫µn ƒë·ªÉ reuse

### Tech Stack Requirements

[Source: architecture/3-tech-stack.md]

**UI Technology Stack:**

- **Frontend Framework**: Next.js 14+ - Framework React m·∫°nh m·∫Ω v·ªõi App Router
- **UI Library**: Tailwind CSS - X√¢y d·ª±ng giao di·ªán nhanh ch√≥ng v√† nh·∫•t qu√°n
- **UI Components**: Shadcn/ui - Component ƒë·∫πp, d·ªÖ t√πy ch·ªânh, t√°i s·ª≠ d·ª•ng
- **State Management**: Zustand - Nh·∫π, ƒë∆°n gi·∫£n, hi·ªáu qu·∫£ cho nhu c·∫ßu d·ª± √°n
- **Icon System**: Lucide React - Professional icons, SVG-based, tree-shakeable

### Project Structure Requirements

[Source: architecture/6-unified-project-structure.md]

**Layout Components Location:**

```
apps/web/src/components/layout/
‚îú‚îÄ‚îÄ AppLayout.tsx (NEW)
‚îú‚îÄ‚îÄ AppHeader.tsx (NEW)
‚îú‚îÄ‚îÄ SettingsModal.tsx (NEW)
‚îú‚îÄ‚îÄ SettingsButton.tsx (NEW)
‚îî‚îÄ‚îÄ CoordinateDisplay.tsx (NEW)
```

**Canvas Components Enhancement:**

```
apps/web/src/components/canvas/
‚îú‚îÄ‚îÄ CanvasContainer.tsx (ENHANCE existing)
‚îú‚îÄ‚îÄ CanvasBackground.tsx (NEW)
‚îú‚îÄ‚îÄ GridBackground.tsx (NEW)
‚îî‚îÄ‚îÄ DotsBackground.tsx (NEW)
```

**Hooks and Stores:**

```
apps/web/src/hooks/ui/
‚îú‚îÄ‚îÄ useSettings.ts (NEW)
‚îú‚îÄ‚îÄ useTheme.ts (NEW)
‚îú‚îÄ‚îÄ useLocalization.ts (NEW)
‚îî‚îÄ‚îÄ useMousePosition.ts (ENHANCE existing)

apps/web/src/store/
‚îú‚îÄ‚îÄ settings.store.ts (NEW)
‚îî‚îÄ‚îÄ canvas.store.ts (ENHANCE existing)
```

### UI Components Architecture

[Source: architecture/31-ui-components-architecture.md]

**Component Architecture Patterns:**

```typescript
// UI Shell Component Pattern
interface UIComponentProps {
  className?: string;
  children?: React.ReactNode;
  variant?: "primary" | "secondary";
}

// Theme Configuration
interface ThemeConfig {
  colors: {
    primary: string;
    secondary: string;
    accent: string;
    background: string;
  };
  typography: {
    fontFamily: string;
    fontSize: Record<string, number>;
  };
  spacing: Record<string, number>;
}

// Localization Configuration
interface LocalizationConfig {
  language: "vi" | "en";
  messages: Record<string, string>;
  dateFormat: string;
  numberFormat: Intl.NumberFormatOptions;
}
```

### Application Shell Architecture

[Source: architecture/62-application-shell-architecture.md]

**Layout System Implementation:**

```typescript
// Application Layout Structure
interface AppLayoutProps {
  children: React.ReactNode;
}

const AppLayout: React.FC<AppLayoutProps> = ({ children }) => (
  <div className="h-screen w-screen flex flex-col">
    <AppHeader />
    <main className="flex-1 relative overflow-hidden">{children}</main>
    <CoordinateDisplay />
    <SettingsModal />
  </div>
);

// Header Component Architecture
interface AppHeaderProps {
  className?: string;
}

const AppHeader: React.FC<AppHeaderProps> = ({ className }) => (
  <header className={`bg-white border-b border-gray-200 ${className}`}>
    <div className="flex items-center justify-between px-6 py-3">
      <div className="flex-1" />
      <div className="flex items-center">
        <h1 className="text-2xl font-bold text-gray-900">Floro</h1>
      </div>
      <div className="flex-1 flex justify-end">
        <SettingsButton />
      </div>
    </div>
  </header>
);
```

**Settings System Architecture:**

```typescript
// Settings Modal Component
interface SettingsModalProps {
  isOpen: boolean;
  onClose: () => void;
}

// Settings Categories
interface SettingsCategory {
  id: string;
  title: string;
  icon: React.ComponentType;
  component: React.ComponentType<SettingsCategoryProps>;
}

const settingsCategories: SettingsCategory[] = [
  {
    id: "display",
    title: "Hi·ªÉn th·ªã",
    icon: Monitor,
    component: DisplaySettings,
  },
  {
    id: "canvas",
    title: "Canvas",
    icon: Grid,
    component: CanvasSettings,
  },
  {
    id: "collaboration",
    title: "C·ªông t√°c",
    icon: Users,
    component: CollaborationSettings,
  },
];
```

**Canvas Background System:**

```typescript
// Canvas Background Types
type CanvasBackgroundType = "none" | "grid" | "dots" | "lines";

interface CanvasBackgroundProps {
  type: CanvasBackgroundType;
  size: number;
  color: string;
  opacity: number;
  viewport: CanvasViewport;
}

// Background Rendering Strategies
const backgroundRenderers = {
  grid: (props: CanvasBackgroundProps) => <GridBackground {...props} />,
  dots: (props: CanvasBackgroundProps) => <DotsBackground {...props} />,
  lines: (props: CanvasBackgroundProps) => <LinesBackground {...props} />,
  none: () => null,
};
```

**Coordinate Display System:**

```typescript
interface CoordinateDisplayProps {
  position: "top-left" | "top-right" | "bottom-left" | "bottom-right";
  showCanvasCoords: boolean;
  showMouseCoords: boolean;
  format: "decimal" | "integer";
}

const CoordinateDisplay: React.FC<CoordinateDisplayProps> = ({
  position,
  showCanvasCoords,
  showMouseCoords,
  format,
}) => {
  const { viewport } = useCanvasStore();
  const mousePosition = useMousePosition();

  return (
    <div
      className={`fixed ${positionClasses[position]} bg-black/75 text-white px-2 py-1 rounded text-xs font-mono`}
    >
      {showCanvasCoords && (
        <div>
          Canvas: {formatCoordinate(viewport.x, format)},{" "}
          {formatCoordinate(viewport.y, format)}
        </div>
      )}
      {showMouseCoords && (
        <div>
          Mouse: {formatCoordinate(mousePosition.x, format)},{" "}
          {formatCoordinate(mousePosition.y, format)}
        </div>
      )}
    </div>
  );
};
```

### Coding Standards Requirements

[Source: architecture/11-coding-standards.md]

**UI Component Standards:**

- **Components**: PascalCase (AppLayout, SettingsModal, CoordinateDisplay)
- **Hooks**: camelCase v·ªõi use prefix (useSettings, useTheme, useLocalization)
- **Type Safety**: Strict TypeScript mode, explicit return types
- **Props Validation**: All component props must have proper TypeScript interfaces
- **Error Boundaries**: UI components ph·∫£i ƒë∆∞·ª£c wrap trong error boundaries

### Testing Requirements

[Source: architecture/10-testing-strategy.md]

**Testing Standards:**

- **Unit Testing**: Jest for hooks and utility functions
- **Component Testing**: React Testing Library for UI components
- **Integration Testing**: Layout system integration with canvas
- **Test Files**: Co-located v·ªõi source files

**UI Component Testing Requirements:**

- **Layout Testing**: AppLayout structure v√† responsive behavior
- **Modal Testing**: SettingsModal open/close states v√† content rendering
- **Settings Testing**: Settings state management v√† persistence
- **Background Testing**: Canvas background pattern rendering
- **Coordinate Testing**: CoordinateDisplay positioning v√† formatting
- **Localization Testing**: Vietnamese text rendering v√† language switching

**Test File Locations:**

```
apps/web/src/components/layout/__tests__/
‚îú‚îÄ‚îÄ AppLayout.test.tsx
‚îú‚îÄ‚îÄ AppHeader.test.tsx
‚îú‚îÄ‚îÄ SettingsModal.test.tsx
‚îú‚îÄ‚îÄ SettingsButton.test.tsx
‚îî‚îÄ‚îÄ CoordinateDisplay.test.tsx

apps/web/src/hooks/ui/__tests__/
‚îú‚îÄ‚îÄ useSettings.test.ts
‚îú‚îÄ‚îÄ useTheme.test.ts
‚îî‚îÄ‚îÄ useLocalization.test.ts
```

### Vietnamese Localization Specifications

**Required Vietnamese Text Constants:**

```typescript
const vietnameseTexts = {
  // Header
  appTitle: "Floro",

  // Settings
  settings: "C√†i ƒë·∫∑t",
  display: "Hi·ªÉn th·ªã",
  canvas: "Canvas",
  collaboration: "C·ªông t√°c",

  // Display Settings
  showCoordinates: "Hi·ªÉn th·ªã t·ªça ƒë·ªô",
  mouseCoordinates: "T·ªça ƒë·ªô chu·ªôt",
  canvasCoordinates: "T·ªça ƒë·ªô canvas",
  coordinateFormat: "ƒê·ªãnh d·∫°ng t·ªça ƒë·ªô",
  decimal: "Th·∫≠p ph√¢n",
  integer: "S·ªë nguy√™n",

  // Canvas Settings
  backgroundType: "Lo·∫°i n·ªÅn",
  backgroundSize: "K√≠ch th∆∞·ªõc n·ªÅn",
  backgroundOpacity: "ƒê·ªô trong su·ªët",
  theme: "Giao di·ªán",
  light: "S√°ng",
  dark: "T·ªëi",

  // Collaboration Settings
  language: "Ng√¥n ng·ªØ",
  vietnamese: "Ti·∫øng Vi·ªát",
  english: "Ti·∫øng Anh",

  // Common
  save: "L∆∞u",
  cancel: "H·ªßy",
  close: "ƒê√≥ng",
  apply: "√Åp d·ª•ng",
};
```

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (Augment Agent - James üíª)

### Debug Log References

- All tasks completed successfully with comprehensive testing
- Layout system integrated with existing canvas infrastructure
- Settings system implemented with Vietnamese localization
- Background patterns working with viewport awareness
- Coordinate display system functional with configurable options
- **REFACTOR**: Migrated to next-themes for professional theme management
- **REFACTOR**: Implemented react-i18next for internationalization
- **PERFORMANCE**: Optimized DotsBackground to eliminate lag issues
- **IMPROVEMENT**: Added Tailwind dark: classes for smooth theme transitions

### Completion Notes

‚úÖ **Task 1: Application Layout Structure** - Implemented AppLayout, AppHeader, and SettingsButton components with proper integration into main application

‚úÖ **Task 2: Settings Modal System** - Created comprehensive settings modal with Vietnamese content, tabbed interface, and Zustand state management

‚úÖ **Task 3: Canvas Background System** - Implemented CanvasBackground with GridBackground and DotsBackground pattern renderers, integrated with settings

‚úÖ **Task 4: Coordinate Display System** - Created CoordinateDisplay component with configurable positioning, mouse tracking hook, and format options

‚úÖ **Task 5: Vietnamese Localization** - Implemented useLocalization hook with comprehensive Vietnamese text constants and language switching

‚úÖ **Task 6: Unit Testing** - Created comprehensive test suites for all components, hooks, and stores with proper mocking

### Post-Implementation Refactoring

üîÑ **Theme System Refactor** - Migrated from custom theme management to next-themes with Tailwind dark: classes for professional theme switching

üîÑ **Localization Refactor** - Replaced custom localization with react-i18next framework and JSON-based translation files

üîÑ **Performance Optimization** - Optimized DotsBackground component using SVG patterns to eliminate lag issues

### Technical Improvements Summary

**Theme Management:**

- ‚úÖ Migrated from custom theme state to `next-themes`
- ‚úÖ Added system theme detection support
- ‚úÖ Implemented smooth transitions with Tailwind CSS
- ‚úÖ Removed theme dependency from settings store

**Internationalization:**

- ‚úÖ Replaced custom localization with `react-i18next`
- ‚úÖ Organized translations in JSON files by namespace
- ‚úÖ Added support for easy language expansion
- ‚úÖ Maintained Vietnamese as default language

**Performance:**

- ‚úÖ Eliminated DotsBackground lag using SVG patterns
- ‚úÖ Reduced DOM manipulation for background rendering
- ‚úÖ Improved theme switching performance

**Code Quality:**

- ‚úÖ Better separation of concerns
- ‚úÖ Industry-standard libraries for theme/i18n
- ‚úÖ Maintainable translation management
- ‚úÖ Consistent dark mode implementation

### File List

**New Components:**

- `apps/web/src/components/layout/AppLayout.tsx`
- `apps/web/src/components/layout/AppHeader.tsx`
- `apps/web/src/components/layout/SettingsButton.tsx`
- `apps/web/src/components/layout/SettingsModal.tsx`
- `apps/web/src/components/layout/CoordinateDisplay.tsx`
- `apps/web/src/components/layout/settings/DisplaySettings.tsx`
- `apps/web/src/components/layout/settings/CanvasSettings.tsx`
- `apps/web/src/components/layout/settings/CollaborationSettings.tsx`
- `apps/web/src/components/canvas/CanvasBackground.tsx`
- `apps/web/src/components/canvas/GridBackground.tsx`
- `apps/web/src/components/canvas/DotsBackground.tsx`

**New Hooks:**

- `apps/web/src/hooks/ui/useMousePosition.ts`
- ~~`apps/web/src/hooks/ui/useLocalization.ts`~~ (Replaced by react-i18next)

**New Stores:**

- `apps/web/src/store/settings.store.ts` (Updated: removed theme management)

**New Infrastructure:**

- `apps/web/src/lib/i18n.ts` - i18next configuration
- `apps/web/src/components/providers/ThemeProvider.tsx` - next-themes wrapper
- `apps/web/src/components/providers/I18nProvider.tsx` - react-i18next wrapper
- `apps/web/src/components/layout/ThemeToggle.tsx` - Professional theme switcher

**Localization Files:**

- `apps/web/src/locales/vi/common.json` - Vietnamese common texts
- `apps/web/src/locales/vi/settings.json` - Vietnamese settings texts
- `apps/web/src/locales/vi/canvas.json` - Vietnamese canvas texts
- `apps/web/src/locales/en/common.json` - English common texts
- `apps/web/src/locales/en/settings.json` - English settings texts
- `apps/web/src/locales/en/canvas.json` - English canvas texts

**Test Files:**

- `apps/web/src/components/layout/__tests__/AppLayout.test.tsx`
- `apps/web/src/components/layout/__tests__/AppHeader.test.tsx`
- `apps/web/src/components/layout/__tests__/SettingsButton.test.tsx`
- `apps/web/src/components/layout/__tests__/SettingsModal.test.tsx`
- `apps/web/src/components/layout/__tests__/CoordinateDisplay.test.tsx`
- `apps/web/src/components/layout/settings/__tests__/DisplaySettings.test.tsx`
- `apps/web/src/components/canvas/__tests__/CanvasBackground.test.tsx`
- `apps/web/src/hooks/ui/__tests__/useMousePosition.test.ts`
- ~~`apps/web/src/hooks/ui/__tests__/useLocalization.test.ts`~~ (Deprecated after i18n migration)
- `apps/web/src/store/__tests__/settings.store.test.ts` (Updated for theme removal)

**Modified Files:**

- `apps/web/src/app/page.tsx` - Integrated AppLayout
- `apps/web/src/app/layout.tsx` - Added ThemeProvider and I18nProvider
- `apps/web/src/components/canvas/CanvasContainer.tsx` - Added CanvasBackground
- `apps/web/src/components/canvas/CanvasBackground.tsx` - Updated to use next-themes
- `apps/web/src/components/layout/AppLayout.tsx` - Added Tailwind dark: classes
- `apps/web/src/components/layout/AppHeader.tsx` - Migrated to react-i18next
- `apps/web/src/components/layout/SettingsButton.tsx` - Added dark theme support
- `apps/web/src/components/layout/settings/CanvasSettings.tsx` - Integrated ThemeToggle
- `apps/web/src/components/canvas/DotsBackground.tsx` - Performance optimization

### Change Log

| Date       | Version | Description                                    | Author       |
| ---------- | ------- | ---------------------------------------------- | ------------ |
| 2025-07-20 | 1.0     | Initial story creation for UI interface system | Scrum Master |
| 2025-07-20 | 2.0     | Story implementation completed by Dev Agent    | James (Dev)  |
| 2025-07-20 | 2.1     | Refactored to next-themes and react-i18next    | James (Dev)  |
