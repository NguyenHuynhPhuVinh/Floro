# Story 2.2: Hoàn thiện Logic Quản lý Node

## Status

In Progress

## Story

**As a** user,
**I want** to have complete control over file nodes (select, update position, delete),
**so that** I can manage my workspace effectively.

## Acceptance Criteria

1. Người dùng có thể chọn một hoặc nhiều node bằng cách nhấp chuột.
2. Node được chọn hiển thị trạng thái selected rõ ràng (border, highlight).
3. Người dùng có thể kéo thả node để cập nhật vị trí, lưu vào database.
4. Người dùng có thể xóa node bằng phím Delete hoặc context menu.
5. Hệ thống hiển thị loading states khi thực hiện các thao tác.
6. Tất cả thay đổi được lưu vào database và cập nhật UI ngay lập tức.

## Tasks / Subtasks

- [ ] Task 1: Implement Node Selection System (AC: 1, 2)

  - [ ] Create useNodeSelection hook for managing selection state
  - [ ] Create useKeyboardShortcuts hook for platform-specific shortcuts
  - [ ] Add single-click selection functionality to FileNode component
  - [ ] Implement multi-select with Ctrl/Cmd + click
  - [ ] Add visual selection indicators (border, highlight) to FileNode
  - [ ] Update NodesStore with selection state management
  - [ ] Add keyboard shortcuts for Select All (Ctrl+A) and Clear Selection (Escape)
  - [ ] Implement platform-specific keyboard shortcuts (Cmd on macOS, Ctrl on Windows/Linux)

- [ ] Task 2: Enhanced Node Drag and Position Updates (AC: 3)

  - [ ] Enhance existing useNodeDrag hook with database persistence
  - [ ] Implement batch position updates for multiple selected nodes
  - [ ] Add visual feedback during drag operations (ghost/preview)
  - [ ] Ensure drag operations work with canvas pan/zoom system
  - [ ] Add snap-to-grid functionality (optional enhancement)
  - [ ] Implement undo/redo for position changes

- [ ] Task 3: Node Deletion System (AC: 4)

  - [ ] Create useNodeDelete hook for deletion operations
  - [ ] Add Delete key handler for selected nodes
  - [ ] Implement context menu with delete option
  - [ ] Add confirmation dialog for deletion operations
  - [ ] Handle file cleanup in Supabase Storage when deleting FileNodes
  - [ ] Implement soft delete with undo functionality

- [ ] Task 4: Loading States and User Feedback (AC: 5)

  - [ ] Add loading indicators to node operations (select, move, delete)
  - [ ] Implement optimistic updates with rollback on error
  - [ ] Create toast notifications for operation success/failure
  - [ ] Add progress indicators for batch operations
  - [ ] Implement error boundaries for node operation failures

- [ ] Task 5: Unit Testing
  - [ ] Test useNodeSelection hook with single and multi-select scenarios
  - [ ] Test useKeyboardShortcuts hook with platform detection
  - [ ] Test enhanced useNodeDrag hook with database persistence
  - [ ] Test useNodeDelete hook with file cleanup
  - [ ] Test loading states and error handling
  - [ ] Test database synchronization with mock Supabase
  - [ ] Test keyboard shortcuts and accessibility features
  - [ ] Test context menu interactions and animations
  - [ ] Test confirmation dialog workflows

## Dev Notes

### Previous Story Insights

[Source: docs/stories/2.1.story.md#dev-agent-record]

Key learnings từ Story 2.1:

- Canvas infrastructure đã hoàn thành với Konva.js integration
- Zustand store architecture đã được thiết lập cho canvas state management
- FileNode components đã được implement với Konva và Lucide icons
- Database integration đã hoàn thành với proper UUID handling
- Basic drag functionality đã có trong FileNode component với useNodeDrag hook
- NodesLayer và useNodes hook đã được implement cho rendering và state management
- Testing framework đã sẵn sàng với comprehensive coverage

### Tech Stack Requirements

[Source: architecture/3-tech-stack.md]

**Node Management Technology:**

- **State Management**: Zustand - Nhẹ, đơn giản, hiệu quả cho nhu cầu dự án
- **Database**: Supabase Database (PostgreSQL) - SQL database mạnh mẽ, ACID compliance, complex queries
- **2D Canvas Library**: Konva.js - Thư viện canvas hiệu suất cao, hỗ trợ tốt
- **UI Components**: Shadcn/ui - Cung cấp component đẹp, dễ tùy chỉnh, tái sử dụng
- **Testing**: Jest & React Testing Library - Bộ công cụ tiêu chuẩn trong hệ sinh thái React

### Project Structure Requirements

[Source: architecture/6-unified-project-structure.md]

**Node Management Components Location:**

- Node hooks: `apps/web/src/hooks/nodes/`
  - `useNodeSelection.ts` (NEW)
  - `useNodeDelete.ts` (NEW)
  - `useKeyboardShortcuts.ts` (NEW)
  - `useNodeDrag.ts` (ENHANCE existing)
  - `useNodes.ts` (ENHANCE existing)
- Node store: `apps/web/src/store/nodes.store.ts` (ENHANCE existing)
- Node service: `apps/web/src/services/core/node.service.ts` (ENHANCE existing)

**File Structure for Node Management:**

```
apps/web/src/
├── hooks/nodes/
│   ├── useNodeSelection.ts (NEW)
│   ├── useNodeDelete.ts (NEW)
│   ├── useKeyboardShortcuts.ts (NEW)
│   ├── useNodeDrag.ts (ENHANCE)
│   └── useNodes.ts (ENHANCE)
├── store/
│   └── nodes.store.ts (ENHANCE)
├── services/core/
│   └── node.service.ts (ENHANCE)
├── components/nodes/
│   └── FileNode.tsx (ENHANCE)
├── components/ui/
│   ├── ContextMenu.tsx (NEW)
│   ├── ConfirmDialog.tsx (NEW)
│   └── Toast.tsx (NEW)
```

### Data Models Requirements

[Source: architecture/4-data-models.md]

**Node Selection State Interface:**

```typescript
export interface NodeSelectionState {
  selectedNodeIds: Set<string>;
  lastSelectedId?: string;
  selectionBounds?: SpatialBounds;
  isMultiSelect: boolean;
}

export interface NodeOperation {
  type: "create" | "update" | "delete" | "move";
  nodeId: string;
  timestamp: string;
  data?: Partial<FloroNode>;
  previousData?: Partial<FloroNode>;
}

export interface NodeInteractionState {
  isHovered: boolean;
  isDragging: boolean;
  isSelected: boolean;
  isLoading: boolean;
  dragOffset?: { x: number; y: number };
  hoverStartTime?: number;
}
```

**Database Schema Types:**

```typescript
export interface Database {
  public: {
    Tables: {
      floro_nodes: {
        Row: FloroNode;
        Insert: Omit<FloroNode, "id" | "metadata">;
        Update: Partial<Omit<FloroNode, "id">>;
      };
    };
  };
}
```

### API Specifications Requirements

[Source: architecture/5-api-specification-client-side-service-layer.md]

**Enhanced NodeService Interface:**

```typescript
class NodeService {
  // Existing CRUD operations
  static createNode(input: CreateNodeInput): Promise<FloroNode>;
  static updateNode(
    nodeId: string,
    updates: Partial<FloroNode>
  ): Promise<FloroNode>;
  static deleteNode(nodeId: string): Promise<void>;
  static getNodesBySession(sessionId: string): Promise<FloroNode[]>;

  // NEW: Batch operations for multi-select
  static updateMultipleNodes(
    updates: Array<{ nodeId: string; data: Partial<FloroNode> }>
  ): Promise<FloroNode[]>;
  static deleteMultipleNodes(nodeIds: string[]): Promise<void>;

  // NEW: File cleanup for FileNodes
  static deleteFileNode(nodeId: string): Promise<void>; // Handles both DB and Storage cleanup
}
```

**Hook Interfaces:**

```typescript
// useNodeSelection hook
interface UseNodeSelectionReturn {
  selectedNodeIds: Set<string>;
  isSelected: (nodeId: string) => boolean;
  selectNode: (nodeId: string, multiSelect?: boolean) => void;
  selectMultiple: (nodeIds: string[]) => void;
  clearSelection: () => void;
  selectAll: () => void;
  getSelectedNodes: () => FloroNode[];
}

// Enhanced useNodeDrag hook
interface UseNodeDragReturn {
  isDragging: boolean;
  dragOffset: { x: number; y: number };
  handleDragStart: (e: KonvaEventObject<DragEvent>) => void;
  handleDragEnd: (e: KonvaEventObject<DragEvent>) => void;
  isLoading: boolean; // NEW: For database persistence
}

// useNodeDelete hook
interface UseNodeDeleteReturn {
  deleteNode: (nodeId: string) => Promise<void>;
  deleteSelectedNodes: () => Promise<void>;
  isDeleting: boolean;
  showConfirmDialog: boolean;
  confirmDelete: () => void;
  cancelDelete: () => void;
}
```

### State Management Architecture

[Source: architecture/61-state-management-architecture.md]

**Enhanced Nodes Store:**

```typescript
interface NodesState {
  // Node data
  nodes: FloroNode[];

  // Selection state
  selection: NodeSelectionState;

  // Operation history for undo/redo
  history: NodeOperation[];
  historyIndex: number;

  // Loading states
  isLoading: boolean;
  error: string | null;

  // Actions
  addNode: (node: FloroNode) => void;
  updateNode: (id: string, updates: Partial<FloroNode>) => void;
  deleteNode: (id: string) => void;
  selectNode: (id: string, multiSelect?: boolean) => void;
  clearSelection: () => void;
  undo: () => void;
  redo: () => void;

  // NEW: Batch operations
  updateMultipleNodes: (
    updates: Array<{ id: string; data: Partial<FloroNode> }>
  ) => void;
  deleteMultipleNodes: (ids: string[]) => void;
}
```

**Command Pattern for Undo/Redo:**

```typescript
interface Command {
  execute(): Promise<void>;
  undo(): Promise<void>;
  canUndo(): boolean;
  description: string;
}

class MoveNodeCommand implements Command {
  constructor(
    private nodeId: string,
    private oldPosition: { x: number; y: number },
    private newPosition: { x: number; y: number }
  ) {}

  async execute(): Promise<void> {
    // Move node to new position
  }

  async undo(): Promise<void> {
    // Move node back to old position
  }
}

class DeleteNodeCommand implements Command {
  constructor(private node: FloroNode) {}

  async execute(): Promise<void> {
    // Delete node from database and storage
  }

  async undo(): Promise<void> {
    // Restore node to database and storage
  }
}
```

### Component Specifications

**Enhanced FileNode Component Props:**

```typescript
interface FileNodeProps {
  node: FileNode;
  isSelected?: boolean;
  isLoading?: boolean; // NEW: For operation feedback
  onSelect?: (nodeId: string, multiSelect?: boolean) => void;
  onDownload?: (node: FileNode) => void;
  onDelete?: (nodeId: string) => void;
  onContextMenu?: (nodeId: string, position: { x: number; y: number }) => void; // NEW
  scale: number;
}
```

**Context Menu Component Props:**

```typescript
interface ContextMenuProps {
  isOpen: boolean;
  position: { x: number; y: number };
  onClose: () => void;
  items: Array<{
    label: string;
    icon?: string;
    onClick: () => void;
    disabled?: boolean;
    destructive?: boolean;
  }>;
}

// Context Menu Design Specifications
interface ContextMenuDesign {
  // Visual styling
  backgroundColor: "#ffffff";
  borderRadius: "8px";
  boxShadow: "0 4px 12px rgba(0, 0, 0, 0.15)";
  border: "1px solid #e5e7eb";
  minWidth: "160px";
  padding: "4px";

  // Item styling
  itemHeight: "32px";
  itemPadding: "8px 12px";
  itemBorderRadius: "4px";
  hoverBackgroundColor: "#f3f4f6";
  destructiveColor: "#ef4444";
  disabledOpacity: 0.5;

  // Typography
  fontSize: "14px";
  fontWeight: "400";
  lineHeight: "20px";

  // Animation
  enterAnimation: "scale(0.95) opacity(0) → scale(1) opacity(1)";
  exitAnimation: "scale(1) opacity(1) → scale(0.95) opacity(0)";
  animationDuration: "150ms";
  animationEasing: "ease-out";
}

// Standard Context Menu Items for FileNode
const FILE_NODE_CONTEXT_ITEMS = [
  { label: "Tải xuống", icon: "Download", onClick: handleDownload },
  { label: "Sao chép", icon: "Copy", onClick: handleCopy },
  { label: "Đổi tên", icon: "Edit", onClick: handleRename },
  { type: "separator" },
  { label: "Xóa", icon: "Trash2", onClick: handleDelete, destructive: true },
];
```

**Keyboard Shortcuts Specifications:**

```typescript
// Platform-specific keyboard shortcuts
interface KeyboardShortcuts {
  // Selection shortcuts
  selectAll: {
    windows: "Ctrl+A";
    mac: "Cmd+A";
    linux: "Ctrl+A";
  };
  clearSelection: {
    all: "Escape";
  };

  // Node operations
  deleteSelected: {
    all: "Delete" | "Backspace";
  };
  copy: {
    windows: "Ctrl+C";
    mac: "Cmd+C";
    linux: "Ctrl+C";
  };

  // Multi-select modifiers
  multiSelect: {
    windows: "Ctrl+Click";
    mac: "Cmd+Click";
    linux: "Ctrl+Click";
  };
  rangeSelect: {
    all: "Shift+Click";
  };
}

// Keyboard event handler interface
interface UseKeyboardShortcutsReturn {
  handleKeyDown: (event: KeyboardEvent) => void;
  isModifierPressed: (modifier: "ctrl" | "cmd" | "shift" | "alt") => boolean;
  getPlatformModifier: () => "ctrl" | "cmd";
}

// Platform detection utility
const PLATFORM_SHORTCUTS = {
  isMac: () => navigator.platform.toUpperCase().indexOf("MAC") >= 0,
  getModifierKey: () => (PLATFORM_SHORTCUTS.isMac() ? "cmd" : "ctrl"),
  formatShortcut: (shortcut: string) => {
    const modifier = PLATFORM_SHORTCUTS.getModifierKey();
    return shortcut.replace(/ctrl|cmd/i, modifier === "cmd" ? "⌘" : "Ctrl");
  },
};
```

**Confirmation Dialog Props:**

```typescript
interface ConfirmDialogProps {
  isOpen: boolean;
  title: string;
  message: string;
  confirmText?: string;
  cancelText?: string;
  onConfirm: () => void;
  onCancel: () => void;
  destructive?: boolean;
}
```

**Animation Specifications:**

```typescript
// Selection animation configuration
interface SelectionAnimationConfig {
  // Border animation for selected nodes
  borderTransition: {
    property: "border-color, box-shadow";
    duration: "200ms";
    easing: "ease-out";
    selectedBorderColor: "#3b82f6";
    selectedBoxShadow: "0 0 0 2px rgba(59, 130, 246, 0.2)";
  };

  // Hover animation
  hoverTransition: {
    property: "transform, box-shadow";
    duration: "150ms";
    easing: "ease-out";
    hoverTransform: "translateY(-1px)";
    hoverBoxShadow: "0 4px 12px rgba(0, 0, 0, 0.15)";
  };

  // Drag animation
  dragTransition: {
    dragOpacity: 0.8;
    dragScale: 1.05;
    dragZIndex: 1000;
    ghostOpacity: 0.3;
    snapBackDuration: "300ms";
    snapBackEasing: "cubic-bezier(0.34, 1.56, 0.64, 1)";
  };

  // Loading state animation
  loadingAnimation: {
    pulseOpacity: "0.5 → 1.0 → 0.5";
    pulseDuration: "1.5s";
    pulseEasing: "ease-in-out";
    pulseIterations: "infinite";
    spinnerRotation: "0deg → 360deg";
    spinnerDuration: "1s";
    spinnerEasing: "linear";
  };

  // Multi-select animation
  multiSelectAnimation: {
    selectionBoxBorder: "2px dashed #3b82f6";
    selectionBoxBackground: "rgba(59, 130, 246, 0.1)";
    selectionBoxAnimation: "dash-offset 0.5s linear infinite";
    batchSelectDelay: "50ms"; // Stagger animation for multiple nodes
  };
}

// Konva-specific animation utilities
interface KonvaAnimationHelpers {
  // Smooth transitions for Konva components
  createTween: (
    node: Konva.Node,
    config: {
      duration: number;
      easing?: Konva.Easings;
      onFinish?: () => void;
    }
  ) => Konva.Tween;

  // Selection border animation
  animateSelection: (node: Konva.Group, selected: boolean) => void;

  // Drag feedback animation
  animateDragStart: (node: Konva.Group) => void;
  animateDragEnd: (node: Konva.Group) => void;

  // Loading state animation
  animateLoading: (node: Konva.Group, loading: boolean) => void;
}
```

### Coding Standards Requirements

[Source: architecture/11-coding-standards.md]

**Node Management Specific Standards:**

- **Hooks**: camelCase với use prefix (useNodeSelection, useNodeDelete)
- **Services**: camelCase với .service.ts suffix
- **Type Safety**: Strict TypeScript mode, no `any` types
- **Error Boundaries**: Node operation components phải được wrap trong error boundaries
- **Props Validation**: All component props must have proper TypeScript interfaces
- **Event Handlers**: Use proper event typing (KonvaEventObject, MouseEvent, KeyboardEvent)

### Technical Constraints

**Node Selection Constraints:**

- Multi-select phải support Ctrl/Cmd + click pattern
- Selection state phải persist across canvas pan/zoom operations
- Maximum 1000 nodes có thể được select cùng lúc (performance limit)
- Selection bounds calculation cho spatial queries

**Database Integration:**

- Batch operations phải use database transactions
- Optimistic updates với rollback on error
- Position updates phải be debounced để avoid excessive database calls

**Performance Optimization:**

- Node selection rendering phải use React.memo
- Drag operations phải use requestAnimationFrame
- Database operations phải be batched when possible
- Memory cleanup cho event listeners

### Testing

[Source: architecture/10-testing-strategy.md]

**Testing Standards:**

- Unit testing with Jest for hooks and services
- Component testing with React Testing Library
- Integration testing for multi-node operations
- Test files co-located with source files
- Mock Supabase services in tests
- Test coverage for critical paths

**Node Management Testing Requirements:**

- **Unit Testing**: Mock database operations, test business logic
- **Integration Testing**: Multi-node selection, drag-and-drop workflows
- **Component Testing**: Isolated FileNode component testing với mocked dependencies
- **Error Handling Testing**: Network failures, concurrent operations, database errors

**Test File Locations:**

- Hook tests: `apps/web/src/hooks/nodes/__tests__/`
- Component tests: Co-located với source files
- Service tests: `apps/web/src/services/core/__tests__/`

**Test Data Specifications:**

- **Selection scenarios**: Single node, multiple nodes, empty selection, all nodes, range selection
- **Keyboard scenarios**: Platform detection (Mac/Windows/Linux), modifier key combinations, shortcut conflicts
- **Drag scenarios**: Single node drag, multi-node drag, boundary constraints, animation feedback
- **Delete scenarios**: Single delete, batch delete, delete with file cleanup, confirmation dialogs
- **Context menu scenarios**: Right-click positioning, menu item interactions, keyboard navigation
- **Animation scenarios**: Selection transitions, hover effects, loading states, drag feedback
- **Error scenarios**: Network failures, database conflicts, invalid operations
- **Database scenarios**: Optimistic updates, rollback on error, batch operations
- **Accessibility scenarios**: Screen reader compatibility, keyboard-only navigation, focus management

## Change Log

| Date       | Version | Description                                                                           | Author       |
| ---------- | ------- | ------------------------------------------------------------------------------------- | ------------ |
| 2025-07-20 | 1.0     | Initial story creation for node management functionality                              | Scrum Master |
| 2025-07-20 | 1.1     | Removed real-time requirements, simplified scope                                      | Scrum Master |
| 2025-07-20 | 1.2     | Enhanced with detailed design specs, animations, keyboard shortcuts for 10/10 quality | Scrum Master |

## Dev Agent Record

### Agent Model Used

(To be filled by Dev Agent)

### Debug Log References

(To be filled by Dev Agent)

### Completion Notes List

(To be filled by Dev Agent)

### File List

(To be filled by Dev Agent)

## QA Results

(To be filled by QA Agent)
